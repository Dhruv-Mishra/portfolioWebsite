name: Deploy Portfolio

on:
  # Trigger manually from GitHub Actions tab
  workflow_dispatch:
    inputs:
      skip_git:
        description: 'Skip git pull (use code already on server)'
        required: false
        default: false
        type: boolean
      skip_deps:
        description: 'Skip npm ci (code-only change, no package updates)'
        required: false
        default: false
        type: boolean
      skip_build:
        description: 'Skip npm build (only update nginx config)'
        required: false
        default: false
        type: boolean
      skip_nginx:
        description: 'Skip nginx config update & reload'
        required: false
        default: false
        type: boolean
      force:
        description: 'Force deployment (ignore uncommitted changes)'
        required: false
        default: false
        type: boolean

  # Trigger automatically on push to master
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.github/dependabot.yml'
      - 'LICENSE'

# Ensure only one deployment runs at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  DOMAIN: whoisdhruv.com
  # Each machine creates this symlink/alias pointing to its own deploy.sh.
  # Setup: sudo ln -sf /path/to/your/deploy.sh /usr/local/bin/deployWebsite
  DEPLOY_CMD: deployWebsite

jobs:
  deploy:
    name: Deploy to ${{ matrix.server.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      # Don't cancel other servers if one fails
      fail-fast: false
      matrix:
        server:
          - name: production
            host_secret: SERVER_HOST
            user_secret: SERVER_USERNAME
            key_secret: SERVER_SSH_KEY
            port_secret: SERVER_PORT
          # To add more machines, duplicate the block above:
          # - name: staging
          #   host_secret: STAGING_HOST
          #   user_secret: STAGING_USERNAME
          #   key_secret: STAGING_SSH_KEY
          #   port_secret: STAGING_PORT

    environment:
      name: ${{ matrix.server.name }}
      url: https://${{ env.DOMAIN }}

    steps:
      - name: Deployment Started (${{ matrix.server.name }})
        run: |
          echo "## ðŸš€ Deployment Started â€” ${{ matrix.server.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ matrix.server.name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Git | ${{ inputs.skip_git || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Deps | ${{ inputs.skip_deps || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Build | ${{ inputs.skip_build || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Nginx | ${{ inputs.skip_nginx || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Force | ${{ inputs.force || 'false' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to ${{ matrix.server.name }}
        id: deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets[matrix.server.host_secret] }}
          username: ${{ secrets[matrix.server.user_secret] }}
          key: ${{ secrets[matrix.server.key_secret] }}
          port: ${{ secrets[matrix.server.port_secret] }}
          script_stop: true
          command_timeout: 12m
          script: |
            echo "ðŸš€ Deploying to ${{ matrix.server.name }}..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Verify the deployWebsite command exists on this machine
            if ! command -v ${{ env.DEPLOY_CMD }} &>/dev/null; then
              echo "âŒ '${{ env.DEPLOY_CMD }}' command not found on this machine."
              echo ""
              echo "Setup required (run once per machine):"
              echo "  sudo ln -sf /path/to/your/deploy.sh /usr/local/bin/${{ env.DEPLOY_CMD }}"
              echo ""
              echo "Example:"
              echo "  sudo ln -sf /home/ubuntu/portfolio/portfolio/scripts/deploy.sh /usr/local/bin/${{ env.DEPLOY_CMD }}"
              exit 1
            fi

            # Build deploy command with options
            DEPLOY="sudo ${{ env.DEPLOY_CMD }}"

            if [ "${{ inputs.skip_git }}" = "true" ]; then
              DEPLOY="$DEPLOY --skip-git"
              echo "â„¹ï¸  Skipping git pull"
            fi

            if [ "${{ inputs.skip_deps }}" = "true" ]; then
              DEPLOY="$DEPLOY --skip-deps"
              echo "â„¹ï¸  Skipping npm ci"
            fi

            if [ "${{ inputs.skip_build }}" = "true" ]; then
              DEPLOY="$DEPLOY --skip-build"
              echo "â„¹ï¸  Skipping build"
            fi

            if [ "${{ inputs.skip_nginx }}" = "true" ]; then
              DEPLOY="$DEPLOY --skip-nginx"
              echo "â„¹ï¸  Skipping nginx update"
            fi

            if [ "${{ inputs.force }}" = "true" ]; then
              DEPLOY="$DEPLOY --force"
              echo "â„¹ï¸  Force mode enabled"
            fi

            echo "Command: $DEPLOY"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Execute deployment
            $DEPLOY

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ${{ matrix.server.name }}: Deployment completed successfully!"

      - name: Verify Deployment (${{ matrix.server.name }})
        if: success()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets[matrix.server.host_secret] }}
          username: ${{ secrets[matrix.server.user_secret] }}
          key: ${{ secrets[matrix.server.key_secret] }}
          port: ${{ secrets[matrix.server.port_secret] }}
          command_timeout: 2m
          script: |
            echo "ðŸ” Post-deploy verification (${{ matrix.server.name }})..."

            # Check systemd service
            if sudo systemctl is-active --quiet portfolio; then
              echo "âœ… portfolio.service is running"
            else
              echo "âŒ portfolio.service is NOT running"
              sudo journalctl -u portfolio --no-pager -n 10
              exit 1
            fi

            # Check Next.js responds
            HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 5 http://127.0.0.1:3000/ 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Next.js responding (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸  Next.js returned HTTP $HTTP_CODE"
            fi

            # Check nginx
            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… nginx is running"
            else
              echo "âŒ nginx is NOT running"
              exit 1
            fi

            # Disk usage
            echo ""
            echo "ðŸ“Š Disk usage:"
            df -h / | tail -1 | awk '{print "   Used: "$3" / "$2" ("$5" full)"}'

      - name: Deployment Success (${{ matrix.server.name }})
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… ${{ matrix.server.name }}: Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Website:** [https://${{ env.DOMAIN }}](https://${{ env.DOMAIN }})" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed (${{ matrix.server.name }})
        if: failure()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ ${{ matrix.server.name }}: Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH into the server and check: \`/var/log/portfolio-deploy/\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check service status: \`sudo systemctl status portfolio\`" >> $GITHUB_STEP_SUMMARY
          echo "3. View recent logs: \`sudo journalctl -u portfolio --no-pager -n 50\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Run manually: \`sudo deployWebsite\`" >> $GITHUB_STEP_SUMMARY

