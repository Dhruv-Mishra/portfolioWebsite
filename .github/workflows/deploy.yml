name: Deploy Portfolio

on:
  # Trigger manually from GitHub Actions tab
  workflow_dispatch:
    inputs:
      skip_git:
        description: 'Skip git pull (use code already on server)'
        required: false
        default: false
        type: boolean
      skip_deps:
        description: 'Skip npm ci (code-only change, no package updates)'
        required: false
        default: false
        type: boolean
      skip_build:
        description: 'Skip npm build (only update nginx config)'
        required: false
        default: false
        type: boolean
      skip_nginx:
        description: 'Skip nginx config update & reload'
        required: false
        default: false
        type: boolean
      force:
        description: 'Force deployment (ignore uncommitted changes)'
        required: false
        default: false
        type: boolean

  # Trigger automatically on push to master
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.github/dependabot.yml'
      - 'LICENSE'

# Ensure only one deployment runs at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  # GIT_ROOT/portfolio/scripts/deploy.sh
  DEPLOY_SCRIPT: /home/portfolioWebsite/portfolio/portfolio/scripts/deploy.sh
  DOMAIN: whoisdhruv.com

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Use GitHub environment for deployment protection rules (optional)
    environment:
      name: production
      url: https://whoisdhruv.com
    
    steps:
      - name: Deployment Started
        run: |
          echo "## ðŸš€ Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Git | ${{ inputs.skip_git || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Deps | ${{ inputs.skip_deps || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Build | ${{ inputs.skip_build || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Nginx | ${{ inputs.skip_nginx || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Force | ${{ inputs.force || 'false' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to Server
        id: deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script_stop: true
          command_timeout: 12m
          script: |
            echo "ðŸš€ Starting deployment..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Verify deploy script exists
            if [ ! -f "${{ env.DEPLOY_SCRIPT }}" ]; then
              echo "âŒ Deploy script not found: ${{ env.DEPLOY_SCRIPT }}"
              echo "   Expected at: GIT_ROOT/portfolio/scripts/deploy.sh"
              exit 1
            fi
            
            # Build deploy command with options
            DEPLOY_CMD="sudo ${{ env.DEPLOY_SCRIPT }}"
            
            if [ "${{ inputs.skip_git }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --skip-git"
              echo "â„¹ï¸  Skipping git pull"
            fi
            
            if [ "${{ inputs.skip_deps }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --skip-deps"
              echo "â„¹ï¸  Skipping npm ci"
            fi
            
            if [ "${{ inputs.skip_build }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --skip-build"
              echo "â„¹ï¸  Skipping build"
            fi
            
            if [ "${{ inputs.skip_nginx }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --skip-nginx"
              echo "â„¹ï¸  Skipping nginx update"
            fi
            
            if [ "${{ inputs.force }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --force"
              echo "â„¹ï¸  Force mode enabled"
            fi
            
            echo "Command: $DEPLOY_CMD"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Execute deployment
            $DEPLOY_CMD
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"

      - name: Verify Deployment
        if: success()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 2m
          script: |
            echo "ðŸ” Post-deploy verification..."
            
            # Check systemd service
            if sudo systemctl is-active --quiet portfolio; then
              echo "âœ… portfolio.service is running"
            else
              echo "âŒ portfolio.service is NOT running"
              sudo journalctl -u portfolio --no-pager -n 10
              exit 1
            fi
            
            # Check Next.js responds
            HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 5 http://127.0.0.1:3000/ 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Next.js responding (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸  Next.js returned HTTP $HTTP_CODE"
            fi
            
            # Check nginx
            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… nginx is running"
            else
              echo "âŒ nginx is NOT running"
              exit 1
            fi
            
            # Disk usage
            echo ""
            echo "ðŸ“Š Disk usage:"
            df -h / | tail -1 | awk '{print "   Used: "$3" / "$2" ("$5" full)"}'

      - name: Deployment Success
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Website:** [https://${{ env.DOMAIN }}](https://${{ env.DOMAIN }})" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH into the server and check: \`/var/log/portfolio-deploy/\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check service status: \`sudo systemctl status portfolio\`" >> $GITHUB_STEP_SUMMARY
          echo "3. View recent logs: \`sudo journalctl -u portfolio --no-pager -n 50\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Run manually: \`sudo /home/portfolioWebsite/portfolio/portfolio/scripts/deploy.sh\`" >> $GITHUB_STEP_SUMMARY

