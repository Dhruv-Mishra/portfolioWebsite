name: Deploy Portfolio

on:
  # Trigger manually from GitHub Actions tab
  workflow_dispatch:
    inputs:
      skip_git:
        description: 'Skip git pull (use code already on server)'
        required: false
        default: false
        type: boolean
      skip_build:
        description: 'Skip npm build (only update nginx config)'
        required: false
        default: false
        type: boolean
      force:
        description: 'Force deployment (ignore uncommitted changes)'
        required: false
        default: false
        type: boolean

  # Trigger automatically on push to master
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.github/dependabot.yml'
      - 'LICENSE'

# Ensure only one deployment runs at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  DEPLOY_SCRIPT: /home/portfolioWebsite/portfolio/scripts/deploy.sh

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Use GitHub environment for deployment protection rules (optional)
    environment:
      name: production
      url: https://whoisdhruv.com
    
    steps:
      - name: Deployment Started
        run: |
          echo "## ðŸš€ Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Git | ${{ inputs.skip_git || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Build | ${{ inputs.skip_build || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Force | ${{ inputs.force || 'false' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to Server
        id: deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script_stop: true
          command_timeout: 12m
          script: |
            echo "ðŸš€ Starting deployment..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Build deploy command with options
            DEPLOY_CMD="sudo ${{ env.DEPLOY_SCRIPT }}"
            
            if [ "${{ inputs.skip_git }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --skip-git"
              echo "â„¹ï¸  Skipping git pull"
            fi
            
            if [ "${{ inputs.skip_build }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --skip-build"
              echo "â„¹ï¸  Skipping build"
            fi
            
            if [ "${{ inputs.force }}" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --force"
              echo "â„¹ï¸  Force mode enabled"
            fi
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Execute deployment
            $DEPLOY_CMD
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"

      - name: Deployment Success
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Website:** [https://whoisdhruv.com](https://whoisdhruv.com)" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH into the server and check: \`/var/log/portfolio-deploy/\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Run manually: \`sudo deploy-portfolio\`" >> $GITHUB_STEP_SUMMARY

